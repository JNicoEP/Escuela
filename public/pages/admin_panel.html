<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        header {
            background-color: #3498db;
            color: white;
            text-align: center;
            padding: 1em 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        main {
            width: 90%;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        button {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #27ae60;
        }

        button.reject {
            background-color: #e74c3c;
        }

        button.reject:hover {
            background-color: #c0392b;
        }

        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
    <header>
        <h1 id="adminPanelTitulo">Panel de Administración</h1>
        <button id="botonInicio">Ir al Inicio</button>
    </header>
    <main id="adminPanelMain">
        <button id="verDocentes">Ver Docentes</button>
        <button id="verAlumnos">Ver Alumnos</button>
        <button id="verPadres">Ver Padres</button>

        <div id="docentesSeccion" style="display: block;">
            <h2>Docentes</h2>
            <button class="docenteFiltro" data-estado="pendiente">Pendientes</button>
            <button class="docenteFiltro" data-estado="aprobado">Aprobados</button>
            <button class="docenteFiltro" data-estado="rechazado">Rechazados</button>
            <table id="tablaDocentes">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo Electrónico</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaBodyDocentes">
                </tbody>
            </table>
        </div>

        <div id="alumnosSeccion" style="display: none;">
            <h2>Alumnos</h2>
            <button class="alumnoFiltro" data-estado="pendiente">Pendientes</button>
            <button class="alumnoFiltro" data-estado="aprobado">Aprobados</button>
            <button class="alumnoFiltro" data-estado="rechazado">Rechazados</button>
            <table id="tablaAlumnos">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo Electrónico</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaBodyAlumnos">
                </tbody>
            </table>
        </div>

        <div id="padresSeccion" style="display: none;">
            <h2>Padres</h2>
            <button class="padreFiltro" data-estado="pendiente">Pendientes</button>
            <button class="padreFiltro" data-estado="aprobado">Aprobados</button>
            <button class="padreFiltro" data-estado="rechazado">Rechazados</button>
            <table id="tablaPadres">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo Electrónico</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaBodyPadres">
                </tbody>
            </table>
        </div>
    </main>

    <script type="module">
        import supabase from '../js/supabaseClient.js';

        // --- INICIO DEL SCRIPT DE GUARDIA (SEGURIDAD) ---
        (async function checkAdmin() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (!session) {
                console.log("No hay sesión, redirigiendo al inicio.");
                window.location.href = '/index.html';
                return;
            }

            const user = session.user;
            
            // Verificamos el rol (Usando la lógica de 2 pasos)
            const { data: userData, error: userError } = await supabase
                .from('usuario')
                .select('id_rol, ROL(nombre_rol)')
                .eq('id_usuario', user.id)
                .single();

            // (Esta política de Admin RLS debe estar bien)
            if (userError || !userData || userData.ROL.nombre_rol !== 'Administrador') {
                console.error("Acceso denegado. No es administrador.");
                alert("Acceso denegado.");
                window.location.href = '/index.html';
                return;
            }
            
            console.log("Acceso de Administrador verificado.");
            cargarUsuarios('Docente', 'pendiente', tablaDocentes); // Carga inicial
        })();
        // --- FIN DEL SCRIPT DE GUARDIA ---


        // --- LÓGICA DEL PANEL (MIGRADA DE PHP) ---
        const tablaDocentes = document.getElementById('tablaBodyDocentes');
        const tablaAlumnos = document.getElementById('tablaBodyAlumnos');
        const tablaPadres = document.getElementById('tablaBodyPadres');
        const docentesSeccion = document.getElementById('docentesSeccion');
        const alumnosSeccion = document.getElementById('alumnosSeccion');
        const padresSeccion = document.getElementById('padresSeccion');
        const verDocentesBtn = document.getElementById('verDocentes');
        const verAlumnosBtn = document.getElementById('verAlumnos');
        const verPadresBtn = document.getElementById('verPadres');

        let docentesEstado = 'pendiente';
        let alumnosEstado = 'pendiente';
        let padresEstado = 'pendiente';

        // Función para cargar usuarios desde Supabase
        async function cargarUsuarios(rolNombre, estado, tablaBody) {
            tablaBody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
            
            const { data, error } = await supabase
                .from('usuario')
                // ¡¡CORRECCIÓN!! -> 'estado_acceso'
                .select('id_usuario, nombre, email, estado_acceso, ROL(nombre_rol)')
                .eq('ROL.nombre_rol', rolNombre) 
                .eq('estado_acceso', estado); // ¡¡CORRECCIÓN!!

            if (error) {
                console.error('Error cargando usuarios:', error.message);
                tablaBody.innerHTML = '<tr><td colspan="4">Error al cargar datos.</td></tr>';
                return;
            }

            tablaBody.innerHTML = ''; 
            if (data.length === 0) {
                 tablaBody.innerHTML = `<tr><td colspan="4">No se encontraron usuarios ${rolNombre}s ${estado}s.</td></tr>`;
            }

            data.forEach(usuario => {
                let fila = tablaBody.insertRow();
                fila.insertCell(0).textContent = usuario.nombre;
                fila.insertCell(1).textContent = usuario.email;
                fila.insertCell(2).textContent = usuario.estado_acceso; // ¡¡CORRECCIÓN!!
                let celdaAcciones = fila.insertCell(3);

                // ¡¡CORRECCIÓN!! -> 'estado_acceso'
                if (usuario.estado_acceso === 'pendiente') {
                    let botonAprobar = document.createElement('button');
                    botonAprobar.textContent = 'Aprobar';
                    botonAprobar.addEventListener('click', () => cambiarEstadoUsuario(usuario.id_usuario, 'aprobado', rolNombre, tablaBody));
                    celdaAcciones.appendChild(botonAprobar);

                    let botonRechazar = document.createElement('button');
                    botonRechazar.textContent = 'Rechazar';
                    botonRechazar.classList.add('reject');
                    botonRechazar.addEventListener('click', () => cambiarEstadoUsuario(usuario.id_usuario, 'rechazado', rolNombre, tablaBody));
                    celdaAcciones.appendChild(botonRechazar);
                }
            });
        }

        // Función para cambiar el estado en Supabase
        async function cambiarEstadoUsuario(idUsuario, nuevoEstado, rolNombre, tablaBody) {
            
            const { error } = await supabase
                .from('usuario')
                .update({ estado_acceso: nuevoEstado }) // ¡¡CORRECCIÓN!!
                .eq('id_usuario', idUsuario);     

            if (error) {
                console.error('Error al cambiar estado:', error.message);
                alert('Error al cambiar el estado del usuario.');
            } else {
                if (nuevoEstado === 'aprobado') {
                    console.log(`Usuario ${idUsuario} aprobado.`);
                }
                cargarUsuarios(rolNombre, rolNombre === 'Docente' ? docentesEstado : alumnosEstado, tablaBody);
            }
        }

        // --- Event Listeners (Sin cambios) ---
        verDocentesBtn.addEventListener('click', () => {
            docentesSeccion.style.display = 'block';
            alumnosSeccion.style.display = 'none';
            padresSeccion.style.display = 'none';
            cargarUsuarios('Docente', docentesEstado, tablaDocentes);
        });

        verAlumnosBtn.addEventListener('click', () => {
            alumnosSeccion.style.display = 'block';
            docentesSeccion.style.display = 'none';
            padresSeccion.style.display = 'none';
            cargarUsuarios('Alumno', alumnosEstado, tablaAlumnos);
        });

        verPadresBtn.addEventListener('click', () => {
            padresSeccion.style.display = 'block';
            docentesSeccion.style.display = 'none';
            alumnosSeccion.style.display = 'none';
            cargarUsuarios('Padre', padresEstado, tablaPadres);
        });

        document.querySelectorAll('.docenteFiltro').forEach(button => {
            button.addEventListener('click', () => {
                docentesEstado = button.dataset.estado;
                cargarUsuarios('Docente', docentesEstado, tablaDocentes);
            });
        });

        document.querySelectorAll('.alumnoFiltro').forEach(button => {
            button.addEventListener('click', () => {
                alumnosEstado = button.dataset.estado;
                cargarUsuarios('Alumno', alumnosEstado, tablaAlumnos);
            });
        });

        document.querySelectorAll('.padreFiltro').forEach(button => {
            button.addEventListener('click', () => {
                padresEstado = button.dataset.estado;
                cargarUsuarios('Padre', padresEstado, tablaPadres);
            });
        });

        document.getElementById('botonInicio').addEventListener('click', function () {
            window.location.href = '/index.html'; 
        });

    </script>
</body>
</html>